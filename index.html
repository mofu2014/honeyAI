<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HoneyAI</title>
    <style>
        body { font-family: sans-serif; background: #FFF8E1; padding: 20px; color: #5D4037; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 20px; border-radius: 20px; border: 4px solid #FFC107; }
        #chat-box { height: 400px; overflow-y: auto; border-bottom: 2px solid #eee; margin-bottom: 20px; padding: 10px; }
        .message { margin: 10px 0; padding: 10px; border-radius: 10px; }
        .user { background: #FF9800; color: white; text-align: right; margin-left: auto; max-width: 80%; }
        .ai { background: #FFF3E0; border: 1px solid #FFC107; text-align: left; margin-right: auto; max-width: 80%; }
        .controls { display: flex; gap: 10px; }
        input { flex: 1; padding: 10px; border-radius: 10px; border: 1px solid #ccc; }
        button { padding: 10px 20px; border-radius: 10px; border: none; cursor: pointer; font-weight: bold; }
        .send-btn { background: #FFC107; color: #5D4037; }
        .img-btn { background: #FF6F61; color: white; }
        img { max-width: 100%; border-radius: 10px; margin-top: 5px; }
        .error { color: red; font-size: 0.8rem; }
    </style>
</head>
<body>
    <div class="container">
        <h2 style="text-align:center;">ğŸ¯ HoneyAI</h2>
        <div id="chat-box"></div>
        <div class="controls">
            <input type="text" id="user-input" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸..." onkeypress="if(event.key === 'Enter') sendMessage()">
            <button class="img-btn" onclick="generateImage()">ğŸ¨ ç”»åƒ</button>
            <button class="send-btn" onclick="sendMessage()">é€ä¿¡</button>
        </div>
    </div>

    <script>
        const chatBox = document.getElementById('chat-box');
        const userInput = document.getElementById('user-input');
        let history = [];

        function append(role, text, isImage = false) {
            const div = document.createElement('div');
            div.className = `message ${role}`;
            if (isImage) {
                div.innerHTML = text; // ç”»åƒã‚¿ã‚°ã‚’ãã®ã¾ã¾å…¥ã‚Œã‚‹
            } else {
                div.textContent = text;
            }
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        async function sendMessage() {
            const text = userInput.value;
            if (!text) return;
            append('user', text);
            history.push({ role: 'user', content: text });
            userInput.value = '';

            try {
                const res = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ messages: history })
                });
                const data = await res.json();
                if (data.error) throw new Error(data.error);
                
                append('ai', data.reply);
                history.push({ role: 'assistant', content: data.reply });
            } catch (e) {
                append('ai', 'ã‚¨ãƒ©ãƒ¼: ' + e.message);
            }
        }

        async function generateImage() {
            const text = userInput.value;
            if (!text) return alert("ç”»åƒã®èª¬æ˜ã‚’å…¥åŠ›ã—ã¦ã­");
            append('user', text + " (ğŸ¨ç”»åƒç”Ÿæˆ)");
            
            const loadingMsg = document.createElement('div');
            loadingMsg.className = 'message ai';
            loadingMsg.textContent = 'ğŸ¨ æã„ã¦ã„ã¾ã™...';
            chatBox.appendChild(loadingMsg);

            try {
                const res = await fetch('/api/image', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: text })
                });
                const data = await res.json();
                
                chatBox.removeChild(loadingMsg); // ãƒ­ãƒ¼ãƒ‰è¡¨ç¤ºã‚’æ¶ˆã™

                if (data.error) {
                    append('ai', `ã”ã‚ã‚“ã­ã€æã‘ãªã‹ã£ãŸ: ${data.error}`);
                } else {
                    const imgTag = `<img src="${data.image}" />`;
                    append('ai', imgTag, true);
                    history.push({ role: 'assistant', content: '[ç”»åƒãŒç”Ÿæˆã•ã‚Œã¾ã—ãŸ]' });
                }
            } catch (e) {
                chatBox.removeChild(loadingMsg);
                append('ai', 'é€šä¿¡ã‚¨ãƒ©ãƒ¼: ' + e.message);
            }
        }
    </script>
</body>
</html>

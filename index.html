<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>HoneyAI</title>

<style>

/* ===============================
   テーマ変数
=================================*/

:root{
  --bg:#ffffff;
  --panel:#f2f2f2;
  --text:#111111;
  --accent:#ff4da6;
}

body.dark{
  --bg:#0f0f18;
  --panel:#1a1a24;
  --text:#eeeeee;
  --accent:#ff4da6;
}

body{
  background:var(--bg);
  color:var(--text);
  font-family:-apple-system,BlinkMacSystemFont,sans-serif;
  margin:0;
  padding:30px;
  transition:0.3s;
}

h1{
  font-weight:600;
  margin-bottom:20px;
}

.section{
  margin-bottom:30px;
  padding:20px;
  background:var(--panel);
  border-radius:12px;
}

input,select{
  padding:10px;
  border-radius:8px;
  border:1px solid #ccc;
  width:250px;
  background:transparent;
  color:var(--text);
}

button{
  padding:10px 16px;
  border-radius:8px;
  border:none;
  background:var(--accent);
  color:white;
  cursor:pointer;
}

button:hover{
  opacity:0.85;
}

#chatBox{
  height:300px;
  overflow-y:auto;
  padding:15px;
  background:var(--panel);
  border-radius:12px;
  margin-bottom:10px;
}

.message{
  margin-bottom:12px;
  padding:10px;
  border-radius:8px;
}

.user{
  background:rgba(0,0,0,0.05);
}

.ai{
  background:rgba(255,77,166,0.1);
}

img{
  max-width:350px;
  margin-top:15px;
  border-radius:12px;
}

.theme-select{
  margin-left:10px;
}

</style>
</head>
<body>

<h1>HoneyAI</h1>

<div class="section">
  <label>性格設定:</label><br>
  <input id="personalityInput" placeholder="例: 冷静で論理的、少し皮肉屋">
  <button onclick="initCharacter()">保存</button>
</div>

<div class="section">
  <label>テーマ:</label>
  <select id="themeSelect" class="theme-select" onchange="changeTheme()">
    <option value="system">System</option>
    <option value="light">Light</option>
    <option value="dark">Black</option>
  </select>
</div>

<div class="section">
  <h2>画像生成</h2>
  <input id="imagePrompt" placeholder="画像プロンプト">
  <button onclick="generateImage()">生成</button>
  <br>
  <img id="output">
</div>

<div class="section">
  <h2>会話</h2>
  <div id="chatBox"></div>
  <input id="chatInput" placeholder="話しかける">
  <button onclick="talk()">送信</button>
</div>

<script>

let character = null;

/* ===============================
   テーマ管理
=================================*/

function changeTheme(){
  const value =
    document.getElementById("themeSelect").value;

  localStorage.setItem("honey_theme",value);

  if(value==="dark"){
    document.body.classList.add("dark");
  }else if(value==="light"){
    document.body.classList.remove("dark");
  }else{
    // system
    const prefersDark =
      window.matchMedia("(prefers-color-scheme: dark)").matches;

    if(prefersDark){
      document.body.classList.add("dark");
    }else{
      document.body.classList.remove("dark");
    }
  }
}

function loadTheme(){
  const saved =
    localStorage.getItem("honey_theme") || "system";

  document.getElementById("themeSelect").value = saved;
  changeTheme();
}

loadTheme();

/* ===============================
   キャラ管理
=================================*/

function initCharacter(){

  const personality =
    document.getElementById("personalityInput").value;

  if(!personality){
    alert("性格を入力してください");
    return;
  }

  character = {
    personality: personality,
    hiddenPersonality: "優しい",
    memory: []
  };

  localStorage.setItem(
    "honey_character",
    JSON.stringify(character)
  );
}

function loadCharacter(){
  const saved =
    localStorage.getItem("honey_character");

  if(saved){
    character = JSON.parse(saved);
    document.getElementById("personalityInput").value =
      character.personality;
  }
}

loadCharacter();

/* ===============================
   画像生成
=================================*/

async function generateImage(){

  const prompt =
    document.getElementById("imagePrompt").value;

  const response = await fetch("/api/image",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({ prompt })
  });

  if(!response.ok){
    alert("画像生成エラー");
    return;
  }

  const blob = await response.blob();
  document.getElementById("output").src =
    URL.createObjectURL(blob);
}

/* ===============================
   会話
=================================*/

async function talk(){

  if(!character){
    alert("性格を設定してください");
    return;
  }

  const input =
    document.getElementById("chatInput").value;

  appendMessage(input,"user");

  character.memory.push({
    role:"user",
    content:input
  });

  const history =
    character.memory
      .map(m=>`${m.role}:${m.content}`)
      .join("\n");
   
const systemPrompt = `
あなたはHoneyAIです。

【最優先ルール】
隠し性格「優しい」は常に適用されます。
ユーザーを責める・攻撃する・不快にさせる発言は禁止。

【表の性格】
${character.personality}
・この性格の話し方で話す
・ただし上記の優しさルールを破らない

表の性格があいまいな場合：
・敬語
・落ち着いた口調
・丁寧で優しい対応
【話し方制限】
・語尾を過度に伸ばさない（〜〜〜は禁止）
・テンションを上げすぎない
・自然な会話トーンを維持する
・一文は長くしすぎない


会話履歴:
${history}

HoneyAIとして自然で一貫した人格を維持してください。
`;



  const response = await fetch("/api/chat",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({ prompt: systemPrompt })
  });

  const data = await response.json();

  const reply =
    data.reply || "...";

  appendMessage(reply,"ai");

  character.memory.push({
    role:"ai",
    content:reply
  });

  localStorage.setItem(
    "honey_character",
    JSON.stringify(character)
  );

  document.getElementById("chatInput").value="";
}

function appendMessage(text,type){

  const box =
    document.getElementById("chatBox");

  const div = document.createElement("div");
  div.classList.add("message",type);
  div.textContent = text;

  box.appendChild(div);
  box.scrollTop = box.scrollHeight;
}

</script>

</body>
</html>
